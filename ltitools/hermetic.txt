Author.Plugin (component,model,controller)
hermetic/ltitools/
videoquiz
popquiz
quizlesson?

php artisan create:plugin hermetic.ltitools

php artisan create:controller hermetic.ltitools videoquiz
php artisan create:model hermetic.ltitools videoquiz
php artisan create:component hermetic.ltitools videoquiz

Videoquiz : Similar to Quizlesson
    create Assignment, insert with Editor?
    or Resource Selection? 
  
Instructor:
    - upload a video to use or select from list???
    - seek/play to a marker (time) click Add content
    - select quiz template? pre-defined color/style groups
    - select quiz from quizzes (question_banks)
    - select question
    - repeat until all questions in quiz are added?
    - save track file for cues with question ids
    
Student:
    - load selected video and track
    - after last question answered, auto submit quiz, graded as quiz
    

php artisan create:controller hermetic.ltitools popquiz
php artisan create:model hermetic.ltitools popquiz
php artisan create:component hermetic.ltitools popquiz

Popquiz : 
    could have several in a course. Instance name should include/be quiz_name?
    retrieve assignment id
    grade as assignment

-------- Notes:
removed from component.php
    $this->page['recordId'] = $config->id;// UNUSED
    $this->addCss('/modules/system/assets/ui/storm.less', 'core');// UNUSED
    
    
-------- error:
roots line 575
//case "Illuminate\Database\Eloquent\Collection":
case "October\Rain\Database\Collection":

had to switch in order to get quizzes from lms
timed out but data is there now : Home build 382
test on mediafiles server : build 316

After installing in a new course on server, had to switch back.
Does this need to be ( or visa versa )
case "October\Rain\Database\Collection":
    if($data->isEmpty()||($request->getInclude_questions()&& count($data->first()->questions)<1))
    {
        return $this->getQuizzesFromLms($request);
    } else { return $data; }
    
case "Illuminate\Database\Eloquent\Collection":
//default:
    if(is_null($data)||($request->getInclude_questions()&&count($data->questions)<1))
    {
        return $this->getQuizzesFromLms($request);
    } else { return $data; }


--------
october login error:
Hermetic\Ltitools\Updates\CreatePopquizzesTable::Hermetic\Ltitools\Updates\{closure}() must be an instance of October\Rain\Database\Schema\Blueprint, instance of Illuminate\Database\Schema\Blueprint given, 
called in /var/www/html/delphinium/vendor/laravel/framework/src/Illuminate/Database/Schema/Builder.php on line 129 and defined

Adjusted /updates/ to fix errors:

use Schema;
//use October\Rain\Database\Schema\Blueprint;
use October\Rain\Database\Updates\Migration;

class CreatePopquizzesTable extends Migration
{
    public function up()
    {
        //Schema::create('hermetic_ltitools_popquizzes', function(Blueprint $table) {
        Schema::create('hermetic_ltitools_popquizzes', function($table) {
            $table->engine = 'InnoDB';


LtiConfiguration :type = editor

But at first launch, courseID is Undefined
Popquiz.php line 194: $courseId = $_SESSION['courseID'];

SESSION variables get set in LtiConfiguration.php at doBltiHandshake()
Does it need to be sooner? or is editor not calling handshake

In Quizlession I solved the problem like so,
$_SESSION['courseID'] = \Input::get('custom_canvas_course_id');
$_SESSION['userID'] = \Input::get('custom_canvas_user_id');
$_SESSION['domain'] = \Input::get('custom_canvas_api_domain');
$_SESSION['lms'] = \Input::get('custom_canvas_lms');
$_SESSION['roles'] = \Input::get('roles');// I added this for Editor version of LtiConfiguration.php

next err: CanvasHelper
$token = \Crypt::decrypt($_SESSION['userToken']);


Solution:
type=editor is skipping the doBltiHandshake()
lti_message_type = ContentItemSelectionRequest

config.xml includes editor options & custom:
I removed ContentItemSelectionRequest from configuration.xml if $type == 'Editor', this needs to be a separate type in the dropdown?
<lticm:property name="message_type">ContentItemSelectionRequest</lticm:property>

Testing:
lti_message_type = basic-lti-launch-request

Of course this now breaks Quizlesson, unless another Type = contentItem is defined in LtiConfiguration.php

May need contentItemSelectionRequest in order for Instructor to inject the popquiz iframe. similar to quizlesson.

contentItem is reinstated for type=Editor:
 LtiConfiguration.php set return_url and always doBltiHandshake
 
set iframe for content return_url 
 
<p><iframe style="width: 970px; height: 550px;" title="Pop Quiz" src="/courses/420908/external_tools/retrieve
?display=borderless
&amp;url=https%3A%2F%2Fmediafiles.uvu.edu%2Fdelphinium%2Fpopquiz" 
width="300" height="150" allowfullscreen="allowfullscreen" webkitallowfullscreen="webkitallowfullscreen" mozallowfullscreen="mozallowfullscreen"></iframe></p>


2nd launch is basic-lti-launch-request
questions are store/retrieved from db so questions are changable by instructor.

-------- // https://www.edu-apps.org/extensions/content.html
Added ResourceSelection type to LtiConfiguation.php
Moved custom variables in config xml, so they are available for all types.
Also included lms in custom variables

Installed Popquiz in new course. working!

Need assignment id to submit score
$assignmentID = $_POST['custom_canvas_assignment_id'];

is there a Roots submitAssignment ? testing: $roots->submissions($req, $params);

studentId = $_SESSION['userID']
courseId = $_SESSION['courseID']
assignment_id is set after return_url is set, 2nd launch
send assignmentID to RestApi onGradePopquiz

https://canvas.instructure.com/doc/api/submissions.html#method.submissions.create

POST /api/v1/courses/:course_id/assignments/:assignment_id/submissions 



This function must be within each game
function sendGrade() {
    // use RestAPI 
    console.log('assignmentID:',assignmentID);// course in session
    var promise = $.get('onGradePopquiz', {'assignment':assignmentID, 'grade':1}, function (data) {
        console.log('PROMISE result:',data);// retruns submission
    }).fail(function (data1) { console.log('PROMISE failed:',data1); });
}




TestStudent Authorized token, Post:
oauth_consumer_key = mfue-key
oauth_signature_method = HMAC-SHA1
oauth_timestamp = 1480959606
oauth_nonce = slWxWh3rjQxklHJZpUBPI9jCeQamYcI08aPFeersDY
oauth_version = 1.0
context_id = c983cc6e877f399dfc4a62dac191c1cf8b8730a9
context_label = Ed Tech Test Course 2
context_title = DEV_Ed Tech - Test Course 2
custom_canvas_api_domain = uvu.instructure.com
**** custom_canvas_assignment_id = 2972295
custom_canvas_assignment_points_possible = 10
custom_canvas_assignment_title = PopQuiz1
custom_canvas_course_id = 434530
custom_canvas_enrollment_state = active
custom_canvas_lms = canvas
custom_canvas_user_id = 1688499
custom_canvas_user_login_id = 21a64d54cb594be6f1748c1ad4599a23ae6d7d79
custom_lis_course_offering_sourcedid = DEV_EdTech-TestCourse2
custom_lis_person_contact_email_primary =
custom_lis_person_sourcedid =
custom_user_image = https://secure.gravatar.com/avatar/000?s=50&d=https%3A%2F%2Fcanvas.instructure.com%2Fimages%2Fmessages%2Favatar-50.png
**** ext_ims_lis_basic_outcome_url = https://uvu.instructure.com/api/lti/v1/tools/63671/ext_grade_passback
ext_outcome_data_values_accepted = url,text
ext_outcome_result_total_score_accepted = true
ext_outcomes_tool_placement_url = https://uvu.instructure.com/api/lti/v1/turnitin/outcomes_placement/63671
ext_roles = urn:lti:instrole:ims/lis/Student,urn:lti:role:ims/lis/Learner,urn:lti:sysrole:ims/lis/User
launch_presentation_document_target = iframe
launch_presentation_locale = en
launch_presentation_return_url = https://uvu.instructure.com/courses/434530/external_content/success/external_tool_redirect
lis_course_offering_sourcedid = DEV_EdTech-TestCourse2
**** lis_outcome_service_url = https://uvu.instructure.com/api/lti/v1/tools/63671/grade_passback
lis_person_contact_email_primary =
lis_person_name_family = Student
lis_person_name_full = Test Student
lis_person_name_given = Test
**** lis_result_sourcedid = 63671-434530-2972295-1688499-48778799581598dba7d8d53bbac7b303d99befe5
lti_message_type = basic-lti-launch-request
lti_version = LTI-1p0
oauth_callback = about:blank
resource_link_id = c1ab6dc176ed12a00997fb9461ff745dfaf1c63c
resource_link_title = PopQuiz1
roles = Learner
tool_consumer_info_product_family_code = canvas
tool_consumer_info_version = cloud
tool_consumer_instance_contact_email = notifications@instructure.com
tool_consumer_instance_guid = 53ff06d8f8dbd4741ff5bd57b3065b53c1cca411.uvu.instructure.com
tool_consumer_instance_name = Utah Valley University
user_id = 7aac895f0d3c071eac687c46b9b0a7afaf8a2bb3
user_image = https://secure.gravatar.com/avatar/000?s=50&d=https%3A%2F%2Fcanvas.instructure.com%2Fimages%2Fmessages%2Favatar-50.png
oauth_signature = 6beYQSovsmaV1hK9BgVDnt7htyM= 


click TestGrading button:
promise failed:
responseText:""Client error: `POST https://uvu.instructure.com/api/v1/courses/434530/assignments/2972295/submissions?submission%5Bsubmission_type%5D=basic_lti_launch&submission%5Bbody%5D=Present&access_token=14~q1IsPhThGqD6CYMa39AH9tMDqNuWZo8wp3UynObQUSX4kP4Ej09TcOV3XgHYHHhK` resulted in a `401 Unauthorized` response:
{"status":"unauthorized","errors":[{"message":"user not authorized to perform that action"}]}
" on line 107 of /var/www/html/delphinium/plugins/october/drivers/vendor/guzzlehttp/guzzle/src/Exception/RequestException.php"


responseText:""Client error: `POST https://uvu.instructure.com/api/v1/courses/434530/assignments/2972295/submissions?submission%5Bsubmission_type%5D=online_text_entry&submission%5Bbody%5D=Present&access_token=14~q1IsPhThGqD6CYMa39AH9tMDqNuWZo8wp3UynObQUSX4kP4Ej09TcOV3XgHYHHhK` resulted in a `401 Unauthorized` response:
{"status":"unauthorized","errors":[{"message":"user not authorized to perform that action"}]}" on line 107 of /var/www/html/delphinium/plugins/october/drivers/vendor/guzzlehttp/guzzle/src/Exception/RequestException.php"

responseText:""Client error: `POST https://uvu.instructure.com/api/v1/courses/434530/assignments/2972295/submissions?submission%5Bsubmission_type%5D=online_text_entry&submission%5Bbody%5D=Present&submission%5Bassignment_id%5D=2972295&submission%5Bscore%5D=1&submission%5Buser_id%5D=1688499&access_token=14~q1IsPhThGqD6CYMa39AH9tMDqNuWZo8wp3UynObQUSX4kP4Ej09TcOV3XgHYHHhK` resulted in a `401 Unauthorized` response:
{"status":"unauthorized","errors":[{"message":"user not authorized to perform that action"}]}
" on line 107 of /var/www/html/delphinium/plugins/october/drivers/vendor/guzzlehttp/guzzle/src/Exception/RequestException.php"


new test: gradepassback

custom_canvas_assignment_id = 2972295
ext_ims_lis_basic_outcome_url = https://uvu.instructure.com/api/lti/v1/tools/63671/ext_grade_passback
lis_outcome_service_url =       https://uvu.instructure.com/api/lti/v1/tools/63671/grade_passback
lis_result_sourcedid = 63671-434530-2972295-1688499-48778799581598dba7d8d53bbac7b303d99befe5

try sending xmlbody directly to lis_outcome_service_url using curl
https://canvas.instructure.com/doc/api/file.assignment_tools.html
https://www.imsglobal.org/specs/ltiomv1p0/specification

sendGrade: outcomeurl: https://uvu.instructure.com/api/lti/v1/tools/63671/ext_grade_passback
PROMISE result: "{\"errors\":[{\"message\":\"Invalid authorization header\"}],\"error_report_id\":79824957}
Add authorization token header

GuzzleHelper::postOrPutWithCurl($url, $questionsWrap, $token);


new test: sendOAuthBodyPOST
try adding OAuthBody.php

add a getSecret function to LtiConfiguration.php for gradeMedia/RestApi
$instanceFromDB
add OAuthBody.php to /delphinium/roots/classes/



















